# IndexTTS Adapter Dockerfile for RTX 50 Series (5090, etc.)
# 针对 RTX 50 系列显卡优化，使用更新的 CUDA 版本
# 使用本地 index-tts 目录，避免网络问题

FROM nvidia/cuda:12.6.0-cudnn-runtime-ubuntu22.04

# 设置环境变量
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=${CUDA_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}
# RTX 50 系列架构
ENV TORCH_CUDA_ARCH_LIST="9.0"

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    python3.10 \
    python3-pip \
    git \
    git-lfs \
    wget \
    curl \
    ffmpeg \
    libsndfile1 \
    && rm -rf /var/lib/apt/lists/*

# 创建工作目录
WORKDIR /code

# 安装 uv 包管理器
RUN pip3 install -U uv

# 复制本地的 index-tts 目录（包含代码和模型）
# 注意：构建前需要先准备好 index-tts 目录
COPY index-tts /code/index-tts

# 复制适配器代码
COPY api_server.py /code/api_server.py
COPY requirements.txt /code/requirements.txt

# 进入 index-tts 目录并安装依赖
WORKDIR /code/index-tts

# 确保 Git LFS 文件已拉取（如果有）
RUN git lfs install --force 2>/dev/null || true

# 使用 uv 安装 index-tts 依赖
RUN uv sync --all-extras

# 安装适配器依赖
RUN uv pip install -r /code/requirements.txt

# 创建数据目录
RUN mkdir -p /code/data

# 暴露端口
EXPOSE 8080

# 启动命令（使用 uv run 运行）
WORKDIR /code
CMD ["uv", "run", "--directory", "/code/index-tts", "python", "/code/api_server.py"]

